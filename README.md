```text
 ░▒▓██████▓▒░░▒▓████████▓▒░▒▓████████▓▒░▒▓████████▓▒░▒▓███████▓▒░ ░▒▓██████▓▒░░▒▓█▓▒░      ░▒▓██████▓▒░░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓████████▓▒░▒▓██████▓▒░    ░▒▓█▓▒░   ░▒▓██████▓▒░ ░▒▓███████▓▒░░▒▓█▓▒▒▓███▓▒░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓████████▓▒░▒▓█▓▒░░▒▓█▓▒░░▒▓██████▓▒░░▒▓████████▓▒░▒▓██████▓▒░ ░▒▓█████████████▓▒░  
                                                                                                                             
                                                                                                                             
                        ░▒▓████████▓▒░▒▓███████▓▒░ ░▒▓██████▓▒░░▒▓█▓▒░▒▓███████▓▒░░▒▓████████▓▒░                             
                        ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░                                    
                        ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░                                    
                        ░▒▓██████▓▒░ ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒▒▓███▓▒░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓██████▓▒░                               
                        ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░                                    
                        ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░                                    
                        ░▒▓████████▓▒░▒▓█▓▒░░▒▓█▓▒░░▒▓██████▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓████████▓▒░                             
```

# afterglow-engine

*A small offline tool that mines your past audio work for new textures.*


---

## What this is

Imagine this:

In a back room of your studio, you’ve secretly built a machine.

It doesn’t paint.  
It doesn’t choose subjects.  
It never tells you what to do with the canvas.

All it does is this:

You slide in your old work—finished canvases, abandoned panels, primed boards with ghosts of sketches under the gesso, photos of murals that no longer exist, even quick studies on cheap paper you once did just to get your hand moving.

Inside, the machine:

* very carefully **unweaves** each piece,
* separates pigment from gesture,
* peels off glazes from underpainting,
* collects tiny flakes of colour from places no one ever really looked at.

It doesn’t keep compositions.  
It doesn’t remember figures or horizons.

It just saves **texture and colour**:

* a particular bruised green that only ever happened once when two paints misbehaved together,
* the way a translucent violet settled into the tooth of the canvas,
* that dry, scratchy ochre from a brush you forgot to clean,
* the chalky margin where gesso met raw linen.

Then it grinds those fragments down and re-bottles them into small, unlabelled jars:

* “evening wall light,”
* “wet concrete after a storm,”
* “skin in winter,”
* “dust on a forgotten windowsill.”

On your main table, nothing has changed:  
It’s still you, blank surface, brushes, knives, rags.

The only difference is your palette.

Now, when you reach for colour, you’re not just squeezing paint from factory tubes—you’re dipping into **distilled memories of your own work**:

* the atmosphere from a painting you sold years ago,
* the softness from a figure you painted over,
* the strange, accidental pink from a ruined canvas that still haunts you.

What we’ve built is that quiet machine:  
a patient studio assistant that wanders through your archives, gently steals back the colours and surfaces you’ve already invented, and lays them out again as fresh pigment.

So future paintings are not just new images.  
They’re painted with **the ground-up archaeology of everything you’ve ever touched.**

`afterglow-engine` is that idea - sonic archaeology, implemented in code.

It doesn’t make tracks.  
It doesn’t make creative choices.  
It just walks your archive and turns the **afterglow** of your work into new material.

---

## Quick Start

The short version:

```bash
# 1. Create and activate a virtualenv
python -m venv venv
source venv/bin/activate

# 2. Install dependencies
pip install -r requirements.txt

# 3. Generate textures from the default folders using the default config
python validate_config.py          # optional but recommended
python make_textures.py --all
```

## What’s New in the Machine (v0.3)

- **Pre-analysis of your archive**: finds stable regions (low onset, sane RMS, low DC/crest), filters grains/pads by quality, and tags brightness. You can toggle it off or tune it in `pre_analysis` (window/hop, RMS/onset/DC/crest thresholds, grain quality, enabled flag).
- **Granular clouds, refined**: per-grain length variation, quality-scored grains, adaptive pitch-shift (no tiny-grain artifacts), stereo export, brightness tags, optional seeds for repeatability.
- **Pad mining, aligned**: pad extraction uses the same stability criteria as clouds when pre-analysis is enabled; brightness tags and stereo/mono export are configurable.
- **Hiss/air layers**: hiss loops and flickers with band-pass/high-pass and tremolo options.
- **Reproducibility & logging**: set `reproducibility.random_seed` for deterministic runs; enable verbose pre-analysis logs via `dsp_utils.set_verbose(True)` (default is quiet).

## Where Everything Lives

- **Source & scripts**: code and configs live here in the root (`musiclib/`, `make_textures.py`, `config.yaml`).
- **Archived docs**: detailed guides, reviews, and batch workflow docs now live in `archive/docs/` (e.g., `CONFIG_QUICK_REFERENCE.md`, `UPGRADES.md`, `BATCH_WORKFLOW.md`, summaries).
- **Archived audio sources**: large example/legacy audio folders are under `archive/audio_sources/` (kept out of the way for GitHub).

## Testing (smoke & verification)

- Minimal regression suite: `python test_review_fixes.py` (uses the current venv; covers pre-analysis wiring, stability masks, pitch-shift guards, logging toggles, and threshold effects).
- Determinism: set `reproducibility.random_seed` in your config to make test runs repeatable.

## Dependencies & Notes

- **librosa** is required for pitch shifting and some analysis paths; if it’s absent, those paths fail gracefully (cloud pitch-shift is skipped), but install the full requirements for intended behavior.
- Exports are WAVs (44.1 kHz, 16/24-bit) organized by source folder.

## Features

- **Pad Mining**: Automatically extract short, loopable pad segments from existing audio files
- **Drone Generation**: Time-stretch, pitch-shift, and process audio into pad loops and swells with tonal variants (warm, airy, dark)
- **Granular Clouds**: Turn any audio into abstract, evolving textures using granular synthesis
- **Hiss & Air**: Generate high-frequency layers and flicker bursts from drums or synthetic noise

All outputs are optimized for TR-8S import (44.1 kHz, 24-bit or 16-bit WAV).

## Setup

### Prerequisites

- Python 3.8+
- macOS or Linux

### Installation

```bash
cd ~/repos/music
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

## Project Structure

```
.
├── config.yaml                   # Configuration (auto-generated on first run)
├── requirements.txt              # Python dependencies
├── README.md                     # This file
├── make_textures.py              # Main CLI entrypoint
├── musiclib/                     # Python package
│   ├── __init__.py
│   ├── io_utils.py               # File discovery, loading, saving
│   ├── segment_miner.py          # Pad mining from sustained segments
│   ├── drone_maker.py            # Pad loops & swells with variants
│   ├── granular_maker.py         # Granular cloud generator
│   ├── hiss_maker.py             # Hiss loops & flicker bursts
│   └── dsp_utils.py              # Filters, envelopes, normalization
├── source_audio/                 # Drop your audio files here
├── pad_sources/                  # Hand-picked tonal material (optional)
├── drums/                        # Percussive material for hiss (optional)
└── export/
    └── <Source_Name>/
        ├── pads/                 # Loopable pad outputs
        ├── swells/               # Swell one-shots
        ├── clouds/               # Granular textures
        └── hiss/                 # Hiss loops & flickers
```

## Usage

### One Command: Generate Everything

```bash
python make_textures.py --all
```

### Individual Steps

```bash
# Extract short pads from sustained regions of existing audio
python make_textures.py --mine-pads

# Generate tonal pad loops and swells with variants
python make_textures.py --make-drones

# Create granular cloud textures
python make_textures.py --make-clouds

# Generate hiss loops and flicker bursts
python make_textures.py --make-hiss
```

### View Help

```bash
python make_textures.py --help
```

## Configuration

On first run, a default `config.yaml` is created with commented values. Customize it to adjust:

- **Sample rate & bit depth** (global)
- **Pad mining thresholds** (RMS, onset rate, duration, multiple target durations, loop crossfade)
- **Drone processing** (pitch shifts, time-stretch, filter variants)
- **Cloud granular parameters** (grain length, count, pitch variation range)
- **Hiss settings** (band-pass frequency range, modulation, synthetic noise)
- **Export options** (stereo vs mono per category)
- **Brightness tagging** (spectral centroid-based dark/mid/bright classification)

See `config.yaml` for all tunable parameters with inline documentation.

### New Features (v0.2)

**Multiple Pad Durations**: `pad_miner.target_durations_sec` now accepts a list (e.g., `[2.0, 3.5]`), allowing pads of different lengths to be extracted from the same source.

**Configurable Loop Crossfade**: `pad_miner.loop_crossfade_ms` controls the crossfade length used to create seamless pad loops.

**Per-Category Stereo/Mono Export**:
- `export.pads_stereo`, `export.swells_stereo`, `export.clouds_stereo`, `export.hiss_stereo`
- Set to `true` to preserve or create stereo versions of textures

**Configurable Granular Pitch Range**: `clouds.pitch_shift_range` with `min` and `max` (in semitones) replaces the old single `max_pitch_shift_semitones`.

**Configurable Hiss Band-Pass Frequencies**:
- `hiss.bandpass_low_hz` and `hiss.bandpass_high_hz` let you adjust the high-frequency range for hiss loops and flickers.

**Brightness Tagging**: Filenames now include `_dark`, `_mid`, or `_bright` tags based on spectral centroid analysis (for pads and clouds).
- Control via `brightness_tags.enabled`, `centroid_low_hz`, `centroid_high_hz`

## Workflow

### 1. Prepare Your Audio

Place audio files in the appropriate directories:

- `source_audio/` → Material to scan for extractable pads
- `pad_sources/` → Hand-picked tonal samples for drone processing
- `drums/` → Percussive material for hiss extraction (optional; synthetic noise used as fallback)

Supported formats: WAV, AIFF, FLAC

### 2. Run the Pipeline

```bash
python make_textures.py --all
```

The tool will:
1. Mine sustained segments from `source_audio/` → `export/<source>/pads/`
2. Process `pad_sources/` into variants → `export/<source>/pads/` & `export/<source>/swells/`
3. Generate granular clouds → `export/<source>/clouds/`
4. Create hiss textures → `export/<source>/hiss/`

### 3. Import to TR-8S

Copy folders from `export/` to your TR-8S SD card sample folder:

```bash
cp -r export/* /Volumes/TR8S/SAMPLES/
```

(Adjust path to match your TR-8S mount point)

## Output Naming

- **Pads**: `<sourceName>_pad01.wav`, `<sourceName>_pad_warm.wav`, etc.
- **Swells**: `<sourceName>_swell01.wav`, etc.
- **Clouds**: `cloud_<sourceName>_01.wav`, etc.
- **Hiss**: `hiss_loop_01.wav`, `hiss_flicker_01.wav`, etc.

## Audio Format

All outputs:
- **Sample rate**: 44,100 Hz (TR-8S standard)
- **Bit depth**: 24-bit or 16-bit (configurable)
- **Format**: Mono or stereo WAV
- **Normalization**: Peak level ~-1 dBFS

## Tips & Tricks

- **Faster Processing**: Run individual steps (`--mine-pads`, `--make-drones`, etc.) as needed rather than `--all`
- **Adjust Sensitivity**: Tweak thresholds in `config.yaml` (RMS range, onset rate, etc.) to get better pad candidates
- **Experiment with Variants**: Time-stretch factors and pitch shifts in config multiply the output variations
- **Layer Textures**: Combine pads + clouds + hiss in your TR-8S sampler for rich, evolving soundscapes

## Troubleshooting

**"No audio files found"**: Ensure files are in the correct directories and use supported formats (WAV, AIFF, FLAC).

**"Config not found, creating default"**: Normal on first run. Customize `config.yaml` and re-run.

**"Output is too quiet/loud"**: Adjust `global.target_peak_dbfs` in `config.yaml`.

**"Pads don't loop smoothly"**: Increase `pad_miner.crossfade_ms` in config.

## Technical Details

- **Librosa**: Audio loading, time-stretching, pitch-shifting, onset detection
- **NumPy**: Windowing, signal processing, grain manipulation
- **SciPy**: IIR/FIR filters for tonal variants and DSP
- **Soundfile**: WAV output with full bit-depth control

## License

Use this tool freely for your own sound design workflows.